<?xml version="1.0" encoding="UTF-8"?>
<sequence xmlns="http://ws.apache.org/ns/synapse" name="PaymentInitRequestValidateTrn" trace="enable">
	<log level="full"/>


   <dblookup>
        <connection>
            <pool>
                <dsName>DB2_FDATA</dsName>
            </pool>
        </connection>
        <statement>
            <sql>select 1 as Existe from TEF.TB_REQUERIMIENTOS_API WHERE CODIGO_EST = ? AND ID_TRANSACCION_EST = ?</sql>
         <parameter expression="get-property('req_MerchantIdentification')" type="VARCHAR"/>
         <parameter expression="get-property('req_TransactionIdentification')" type="VARCHAR"/>

            <result name="PaymentInitTrnAlreadyExists" column="Existe"/>
        </statement>
    </dblookup>

    <filter xpath="get-property('PaymentInitTrnAlreadyExists')">
	<then>
		<property name="ResultCode" value="0200001"/>
		<property name="ResultMessage" value="El comercio/transaccion ya existe"/>
		<sequence key="PaymentInitResponse"/>
		
	</then>
    </filter>

   <dblookup>
        <connection>
            <pool>
                <dsName>DB2_FDATA</dsName>
            </pool>
        </connection>
        <statement>
            <sql>select 1 as Existe from TEFADMIN.TB_ESTS WHERE CODIGO_EST = ?</sql>
         <parameter expression="get-property('req_MerchantIdentification')" type="VARCHAR"/>

            <result name="PaymentInitMerchantExists" column="Existe"/>
        </statement>
    </dblookup>

    <filter xpath="get-property('PaymentInitMerchantExists')">
	<then/>
	<else>
		<property name="ResultCode" value="0200002"/>
		<property name="ResultMessage" value="El comercio no existe"/>
		<sequence key="PaymentInitResponse"/>
		
	</else>
    </filter>


</sequence>
